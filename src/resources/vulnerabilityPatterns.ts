import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';

const vulnerabilityPatterns = {
  description: 'Common vulnerability patterns by programming language',
  languages: {
    javascript: {
      name: 'JavaScript/TypeScript',
      patterns: [
        {
          category: 'Injection',
          vulnerabilities: [
            {
              name: 'eval() usage',
              pattern: 'eval(',
              severity: 'critical',
              description: 'Direct code execution from string input',
              remediation: 'Use JSON.parse() for data, avoid eval() entirely',
            },
            {
              name: 'Function constructor',
              pattern: 'new Function(',
              severity: 'critical',
              description: 'Creates function from string, similar to eval',
              remediation: 'Avoid dynamic function creation from user input',
            },
            {
              name: 'innerHTML assignment',
              pattern: '.innerHTML =',
              severity: 'high',
              description: 'Direct HTML injection leading to XSS',
              remediation: 'Use textContent or DOMPurify for sanitization',
            },
            {
              name: 'document.write',
              pattern: 'document.write(',
              severity: 'medium',
              description: 'Legacy DOM manipulation, potential XSS',
              remediation: 'Use modern DOM APIs instead',
            },
          ],
        },
        {
          category: 'Command Execution',
          vulnerabilities: [
            {
              name: 'child_process.exec',
              pattern: 'exec(',
              severity: 'critical',
              description: 'Shell command execution',
              remediation: 'Use execFile() with argument array, validate input',
            },
            {
              name: 'child_process.spawn with shell',
              pattern: 'spawn(.*shell: true',
              severity: 'high',
              description: 'Shell spawning enables command injection',
              remediation: 'Set shell: false, use argument arrays',
            },
          ],
        },
        {
          category: 'Path Traversal',
          vulnerabilities: [
            {
              name: 'Unsanitized file path',
              pattern: 'readFile(.*req\\.',
              severity: 'high',
              description: 'File read with user-controlled path',
              remediation: 'Use path.resolve() and validate against base directory',
            },
          ],
        },
        {
          category: 'Prototype Pollution',
          vulnerabilities: [
            {
              name: 'Dynamic property assignment',
              pattern: '\\[.*\\] =',
              severity: 'high',
              description: 'Object property manipulation from user input',
              remediation: 'Use Object.create(null), validate property names',
            },
            {
              name: 'Object.assign with user data',
              pattern: 'Object.assign(.*req\\.',
              severity: 'medium',
              description: 'Merging user data can pollute prototype',
              remediation: 'Use structured cloning or validate keys',
            },
          ],
        },
      ],
    },
    python: {
      name: 'Python',
      patterns: [
        {
          category: 'Injection',
          vulnerabilities: [
            {
              name: 'eval() usage',
              pattern: 'eval(',
              severity: 'critical',
              description: 'Arbitrary code execution',
              remediation: 'Use ast.literal_eval() for data parsing',
            },
            {
              name: 'exec() usage',
              pattern: 'exec(',
              severity: 'critical',
              description: 'Arbitrary code execution',
              remediation: 'Avoid exec(), use safer alternatives',
            },
            {
              name: 'SQL string formatting',
              pattern: 'execute(.*%|execute(.*format|execute(.*f"',
              severity: 'critical',
              description: 'SQL injection via string formatting',
              remediation: 'Use parameterized queries with placeholders',
            },
          ],
        },
        {
          category: 'Deserialization',
          vulnerabilities: [
            {
              name: 'pickle.loads',
              pattern: 'pickle.loads?(',
              severity: 'critical',
              description: 'Arbitrary code execution via pickle',
              remediation: 'Use JSON or implement secure deserialization',
            },
            {
              name: 'yaml.load without SafeLoader',
              pattern: 'yaml.load((?!.*SafeLoader)',
              severity: 'high',
              description: 'YAML deserialization can execute code',
              remediation: 'Always use yaml.safe_load() or SafeLoader',
            },
          ],
        },
        {
          category: 'Command Execution',
          vulnerabilities: [
            {
              name: 'os.system',
              pattern: 'os.system(',
              severity: 'critical',
              description: 'Shell command execution',
              remediation: 'Use subprocess with shell=False',
            },
            {
              name: 'subprocess with shell=True',
              pattern: 'shell=True',
              severity: 'high',
              description: 'Shell execution enables injection',
              remediation: 'Use shell=False with argument list',
            },
          ],
        },
        {
          category: 'Path Traversal',
          vulnerabilities: [
            {
              name: 'open() with user path',
              pattern: 'open(.*request\\.',
              severity: 'high',
              description: 'File access with user-controlled path',
              remediation: 'Use os.path.realpath() and validate base directory',
            },
          ],
        },
      ],
    },
    go: {
      name: 'Go',
      patterns: [
        {
          category: 'Injection',
          vulnerabilities: [
            {
              name: 'SQL string concatenation',
              pattern: 'Query(.*\\+|Exec(.*\\+',
              severity: 'critical',
              description: 'SQL injection via string concatenation',
              remediation: 'Use prepared statements with ? placeholders',
            },
            {
              name: 'html/template type assertion',
              pattern: 'template.HTML(',
              severity: 'high',
              description: 'Bypasses HTML escaping',
              remediation: 'Validate and sanitize before marking as safe',
            },
          ],
        },
        {
          category: 'Command Execution',
          vulnerabilities: [
            {
              name: 'exec.Command with user input',
              pattern: 'exec.Command(.*request\\.',
              severity: 'critical',
              description: 'Command injection via user input',
              remediation: 'Validate input, use allowlist of commands',
            },
          ],
        },
      ],
    },
    java: {
      name: 'Java',
      patterns: [
        {
          category: 'Injection',
          vulnerabilities: [
            {
              name: 'SQL string concatenation',
              pattern: 'executeQuery(.*\\+|executeUpdate(.*\\+',
              severity: 'critical',
              description: 'SQL injection via string concatenation',
              remediation: 'Use PreparedStatement with parameterized queries',
            },
            {
              name: 'LDAP injection',
              pattern: 'search(.*\\+',
              severity: 'high',
              description: 'LDAP injection via string concatenation',
              remediation: 'Use parameterized LDAP queries',
            },
          ],
        },
        {
          category: 'Deserialization',
          vulnerabilities: [
            {
              name: 'ObjectInputStream',
              pattern: 'ObjectInputStream',
              severity: 'critical',
              description: 'Deserialization of untrusted data',
              remediation: 'Use allowlist of classes, avoid deserializing untrusted data',
            },
            {
              name: 'XMLDecoder',
              pattern: 'XMLDecoder',
              severity: 'critical',
              description: 'XML deserialization can execute code',
              remediation: 'Avoid XMLDecoder, use safer XML parsers',
            },
          ],
        },
        {
          category: 'XXE',
          vulnerabilities: [
            {
              name: 'DocumentBuilder without security',
              pattern: 'DocumentBuilderFactory.newInstance()',
              severity: 'high',
              description: 'XML parsing vulnerable to XXE by default',
              remediation: 'Disable external entities and DTDs',
            },
          ],
        },
      ],
    },
  },
};

export function registerVulnerabilityPatternsResource(server: McpServer): void {
  server.resource(
    'vulnerability-patterns',
    'security://vulnerability-patterns',
    {
      description: 'Common vulnerability patterns organized by programming language',
      mimeType: 'application/json',
    },
    async (uri) => ({
      contents: [
        {
          uri: uri.href,
          mimeType: 'application/json',
          text: JSON.stringify(vulnerabilityPatterns, null, 2),
        },
      ],
    })
  );
}
